<!DOCTYPE HTML>
<html style="overflow: hidden;">
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }

    </style>
    <script src="kinetic-v3.10.5.min.js"></script>
    <script src="jquery-1.6.3.min.js"></script>
    <script src="magicgesture.js"></script>
    <script>
    document.addEventListener('GLALoad', onGLALoad, false);
    function onGLALoad(event) {
      GLA.SetTuioEnabled(true);
    }

    var stage;
    var serverImageList = [];

    function pool(){
      $.ajax({
        type: "GET",
        data: {"action":"getImageList"},
        dataType: 'json',
        url: "servlet",
        error: function(xhr, statusText) { },
        success: function(imageList){
          if (imageList.length == 0){
            stage.clear();
          }else if (serverImageList.length != imageList.length){
            stage.clear();
            for (var i = 0; i < imageList.length; i++){
              addImage("photo?id=" + imageList[i]);
            }

          }
          
          serverImageList = imageList;
        }
      });  
    }

    window.onload = function() {
      stage = new Kinetic.Stage({
        container: "container",
        width: $(document).width() - 4,
        height: $(document).height() - 4,
      });

      pool();
      setInterval("pool();", 3000);

      MagicGesture.init();
    };

    function addImage(url){
      var layer = new Kinetic.Layer({alpha:0});

      var imageObj = new Image();
      imageObj.onload = function() {
        var width = this.width;
        var height = this.height;
        var ratio = width / height;
        var maxDimension = 4;
        if (width > $(window).width() / maxDimension){
          width = $(window).width() / maxDimension;
          height = width / ratio;
        }else if (height > $(window).height() / maxDimension){
          height = $(window).height() / maxDimension;
          width = height * ratio;
        }

        var kImage = new Kinetic.Image({
          x: Math.random()*stage.getWidth() - 100,
          y: Math.random()*stage.getHeight() - 100,
          image: imageObj,
          width: width,
          height: height,
          draggable: true,
          alpha: 1,
        });

        layer.on('mousedown', function(evt){
          this.remove();
          stage.add(this);
        });

        layer.add(kImage);
        stage.add(layer);

        layer.transitionTo({alpha:1, duration:0.5});
      };
      imageObj.src = url;
    }

document.addEventListener("gesturestart", gestureStart, false);
document.addEventListener("gesturechange", gestureChange, false);
function gestureChange(event){
  GLA.Log("Scale: " + event.scale);
}
function gestureStart(event){
  GLA.Log("Gesture started");
}
  </script>
  </head>
  <body>
    <div style="width: 300px; height: 200px; background-color: red; position: absolute; top: 10px; left: 10px;">
      DIV 1
    </div>

    <div style="width: 300px; height: 200px; background-color: green; position: absolute; top: 200px; left: 500px;">
      DIV 1
    </div>

    <div id="container"></div>
  </body>
</html>
